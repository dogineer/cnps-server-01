<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.develop.web.domain.service.folder.mapper.FolderMapper">
    <select id="selectFolderRootList" resultType="FolderDto">
        SELECT id,
               name,
               p_id
        FROM folder
        WHERE id != 1 AND p_id = 1
    </select>

    <select id="selectFolderChildrenList" parameterType="Integer" resultType="FolderDto">
        SELECT id,
               name,
               p_id
        FROM folder
        WHERE p_id = #{p_id}
    </select>

    <select id="selectFolderClipData" parameterType="Integer" resultType="ClipDto">
        WITH RECURSIVE C AS
                           (SELECT id
                            FROM folder
                            WHERE id = ${folderId}
                            UNION ALL
                            SELECT f.id
                            FROM folder f
                                     JOIN C rf ON f.p_id = rf.id)
        SELECT  c.id as clip_id,
                c.ingest_id,
                i.title as `ingest_name`,
                c.team_id,
                t.name as `team_name`,
                c.folder_id,
                f.name as `folder_name`,
                c.convert_metadata_id,
                DATE(c.ingest_at) as ingest_at,
                ROUND(a.size / (1024 * 1024), 2) AS size,
                a.*
        FROM clip c
                 LEFT JOIN ingest i ON i.id = c.ingest_id
                 LEFT JOIN team t ON t.id = c.team_id
                 LEFT JOIN folder f ON f.id = c.folder_id
                 LEFT JOIN convert_metadata a ON a.id = c.convert_metadata_id
        WHERE c.folder_id IN (SELECT id
                              FROM C)
        ORDER BY c.end_at DESC;
    </select>
</mapper>