<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.develop.web.domain.service.folder.mapper.FolderMapper">
    <select id="selectFolderRootList" resultType="FolderDto">
        SELECT id, name, p_id
        FROM folder
        WHERE id != 1 AND p_id = 1
    </select>

    <select id="selectFolderChildrenList" parameterType="Integer" resultType="FolderDto">
        SELECT id, name, p_id
        FROM folder
        WHERE p_id = #{p_id}
    </select>

    <select id="selectFolderClipData" parameterType="Integer" resultType="FolderClipDto">
       WITH RECURSIVE C AS
             (SELECT c.id     AS clip_id,
                 c.ingest_id,
                 i.title  AS `ingest_name`,
                 c.team_id,
                 t.name   AS `team_name`,
                 c.folder_id,
                 f.name   AS `folder_name`,
                 c.convert_metadata_id,
                 c.end_at AS ingest_at,
                 a.*
              FROM clip c
                  LEFT JOIN ingest i
                       ON i.id = c.ingest_id
                  LEFT JOIN team t ON t.id = c.team_id
                  LEFT JOIN folder f ON f.id = c.folder_id
                  LEFT JOIN convert_metadata a ON a.id = c.convert_metadata_id
              WHERE c.folder_id = ${folderId}
              UNION ALL
              SELECT c.id     AS clip_id,
                 c.ingest_id,
                 i.title  AS `ingest_name`,
                 c.team_id,
                 t.name   AS `team_name`,
                 c.folder_id,
                 f.name   AS `folder_name`,
                 c.convert_metadata_id,
                 c.end_at AS ingest_at,
                 a.*
              FROM clip c
                  LEFT JOIN ingest i
                       ON i.id = c.ingest_id
                  LEFT JOIN team t ON t.id = c.team_id
                  LEFT JOIN folder f ON f.id = c.folder_id
                  LEFT JOIN convert_metadata a ON a.id = c.convert_metadata_id
              WHERE c.folder_id IN (SELECT f.id FROM folder f WHERE f.p_id = ${folderId}))
    SELECT C.*
    FROM C
    ORDER BY c.ingest_at DESC;
    </select>
</mapper>